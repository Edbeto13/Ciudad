# Pipeline de ExportaciÃ³n: Three.js â†’ Blender â†’ DXF

Este documento describe el flujo de trabajo para exportar modelos 3D desde el Simulador de Ciudad a AutoCAD mediante Blender como paso intermedio.

## ğŸ“‹ Resumen del Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Simulador       â”‚     â”‚   Blender   â”‚     â”‚   AutoCAD    â”‚
â”‚  (Three.js)      â”‚ â”€â”€â–¶ â”‚   (Import/  â”‚ â”€â”€â–¶ â”‚   (DXF)      â”‚
â”‚                  â”‚     â”‚   Export)   â”‚     â”‚              â”‚
â”‚  Exporta:        â”‚     â”‚             â”‚     â”‚              â”‚
â”‚  - ciudad.obj    â”‚     â”‚  Ajustes:   â”‚     â”‚  Uso final:  â”‚
â”‚  - ciudad.mtl    â”‚     â”‚  - Escala   â”‚     â”‚  - Planos    â”‚
â”‚  - metadata.json â”‚     â”‚  - Capas    â”‚     â”‚  - Renders   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 1ï¸âƒ£ Exportar desde el Simulador

### Paso 1: Preparar la escena
1. AsegÃºrate de tener todos los mÃ³dulos posicionados correctamente
2. Verifica que las unidades sean las correctas (MilÃ­metros, Metros, etc.)

### Paso 2: Exportar archivos
1. Haz clic en **"ğŸ¨ Exportar OBJ"**
2. Se descargarÃ¡n 3 archivos:
   - `ciudad.obj` - GeometrÃ­a 3D
   - `ciudad.mtl` - Materiales
   - `ciudad_metadata.json` - InformaciÃ³n de capas y tipos

### Archivos generados

**ciudad.obj**
```obj
# OBJ file generated by Ciudad Simulator
mtllib ciudad.mtl

# Module 1 (building)
usemtl mat_building
v -0.5000 0.0000 -0.5000
v 0.5000 0.0000 -0.5000
...
f 4 3 2 1
f 5 6 7 8
...
```

**ciudad.mtl**
```mtl
# MTL file generated by Ciudad Simulator

newmtl mat_building
Kd 0.2902 0.5647 0.8510
Ka 0.2 0.2 0.2
Ks 0.5 0.5 0.5

newmtl mat_road
Kd 0.3765 0.4902 0.5451
...
```

**ciudad_metadata.json**
```json
{
  "version": 2,
  "modules": [
    { "id": 1, "type": "building", "layer": "COLUMNAS" },
    { "id": 2, "type": "road", "layer": "PISOS" }
  ]
}
```

## 2ï¸âƒ£ Importar en Blender

### Paso 1: Abrir Blender
- Usa Blender 2.8 o superior
- Crea un nuevo proyecto o usa uno existente

### Paso 2: Importar OBJ
1. Ir a **File â†’ Import â†’ Wavefront (.obj)**
2. Seleccionar `ciudad.obj`
3. Configurar opciones de importaciÃ³n:
   - âœ… Forward: Y Forward
   - âœ… Up: Z Up
   - âœ… Split by Object: ON (para separar mÃ³dulos)

### Paso 3: Verificar materiales
- Los materiales del MTL se importan automÃ¡ticamente
- Verificar en la pestaÃ±a **Materials** del panel de propiedades

### Paso 4: Ajustar escala (si es necesario)
1. Seleccionar todos los objetos (A)
2. Escalar: `S` â†’ escribir factor â†’ `Enter`
3. Aplicar escala: `Ctrl+A` â†’ Scale

## 3ï¸âƒ£ Organizar por capas en Blender

### Usar Collections para capas DXF
1. Crear Collections que correspondan a las capas DXF:
   - `COLUMNAS` - Edificios, comercios
   - `BORDES` - Contornos
   - `TECHOS` - Techos, casas
   - `PISOS` - Carreteras, agua

2. Consultar `ciudad_metadata.json` para asignar objetos:
```python
# Script de Blender para organizar automÃ¡ticamente
import bpy
import json

# Cargar metadata
with open('ciudad_metadata.json', 'r') as f:
    metadata = json.load(f)

# Crear collections
for layer in ['COLUMNAS', 'BORDES', 'TECHOS', 'PISOS']:
    if layer not in bpy.data.collections:
        col = bpy.data.collections.new(layer)
        bpy.context.scene.collection.children.link(col)

# Asignar objetos (ejemplo simplificado)
for mod in metadata['modules']:
    obj_name = f"Module_{mod['id']}"
    if obj_name in bpy.data.objects:
        obj = bpy.data.objects[obj_name]
        layer = mod['layer']
        bpy.data.collections[layer].objects.link(obj)
```

## 4ï¸âƒ£ Exportar a DXF desde Blender

### OpciÃ³n A: Exportador nativo (limitado)
Blender no tiene exportador DXF nativo robusto.

### OpciÃ³n B: Add-on "Export: AutoCAD DXF"
1. Descargar el add-on DXF-Export
2. Instalarlo en **Edit â†’ Preferences â†’ Add-ons â†’ Install**
3. Activar "Import-Export: AutoCAD DXF Format"
4. Exportar: **File â†’ Export â†’ AutoCAD DXF (.dxf)**

### OpciÃ³n C: Exportar como STL/FBX e importar en AutoCAD
1. En Blender: **File â†’ Export â†’ STL (.stl)** o **FBX (.fbx)**
2. En AutoCAD: **Insert â†’ Import** â†’ seleccionar archivo

## 5ï¸âƒ£ Alternativa: ExportaciÃ³n DXF directa

Para muchos casos, la exportaciÃ³n DXF directa desde el simulador es suficiente:

1. Usar el botÃ³n **"ğŸ“ Exportar DXF"** en el simulador
2. El DXF generado incluye:
   - Header con `$INSUNITS`
   - Capas predefinidas (COLUMNAS, BORDES, TECHOS, PISOS)
   - Entidades 3DFACE para superficies
   - LWPOLYLINE para contornos

## ğŸ“Š Comparativa de mÃ©todos

| MÃ©todo | Ventajas | Desventajas |
|--------|----------|-------------|
| DXF directo | RÃ¡pido, sin software adicional | Menos control |
| OBJ â†’ Blender â†’ DXF | Control total, ediciÃ³n | MÃ¡s pasos |
| OBJ â†’ Blender â†’ FBX â†’ AutoCAD | Mejor compatibilidad | Requiere licencia |

## ğŸ”§ ResoluciÃ³n de problemas

### El modelo aparece muy pequeÃ±o/grande
- Verificar unidades en exportaciÃ³n
- Ajustar escala en Blender antes de re-exportar

### Materiales no aparecen
- Verificar que el archivo MTL estÃ© en el mismo directorio
- Verificar que la referencia `mtllib` en el OBJ sea correcta

### Capas no se reconocen en AutoCAD
- Usar exportaciÃ³n DXF directa del simulador
- O asignar capas manualmente en AutoCAD

### GeometrÃ­a invertida (normales)
- En Blender: Seleccionar objeto â†’ Edit Mode â†’ Mesh â†’ Normals â†’ Recalculate Outside
